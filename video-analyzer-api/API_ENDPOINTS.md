# API Эндпоинты

## Сопоставление сцен с сюжетами эпизода

### GET /api/episode-matcher/match-episode/{episode_id}

Сопоставляет сюжетные линии указанного эпизода с имеющимися сценами и сохраняет результат в shared-data директории.

#### Параметры URL
- `episode_id` (string, обязательный): Идентификатор эпизода для сопоставления

#### Пример запроса
```bash
curl -X GET "http://localhost:8000/api/episode-matcher/match-episode/927ad83c-dbb5-4240-937b-81932d904740"
```

#### Ответ
```json
{
  "status": "success",
  "message": "Сопоставление для эпизода 927ad83c-dbb5-4240-937b-81932d904740 выполнено успешно",
  "result_path": "/app/shared-data/results/episode-matches/927ad83c-dbb5-4240-937b-81932d904740.json",
  "match_result": {
    "episode_id": "927ad83c-dbb5-4240-937b-81932d904740",
    "episode_title": "1-ая серия",
    "matched_at": "2024-05-28T12:34:56.789012",
    "storylines": [
      {
        "title": "Прибытие интернов и первое знакомство с Быковым",
        "description": "Четверо интернов приходят на практику в отделение к доктору Быкову...",
        "characters": [
          {
            "name": "Андрей Евгеньевич Быков",
            "description": "Главврач с острым языком и жестким подходом к обучению интернов...",
            "keywords": ["сарказм", "жесткость", "профессионализм"]
          }
        ],
        "keywords": ["вступление", "знакомство", "язвительность", "сравнение", "ирония", "первое впечатление"],
        "scenes": [
          {
            "scene_id": "scene_4",
            "score": 0.85,
            "character_matches": {
              "Андрей Евгеньевич Быков": 0.9
            },
            "keyword_matches": {
              "ирония": 0.78
            },
            "audio_relevance": 0.5,
            "start_time": 30.68,
            "end_time": 45.72,
            "duration": 15.04,
            "transcript": "А быкова нет еще? Да вот нет. Ну, падла! А она сорвешься на опасную скотину! Почему, паскуды? Что за человек-то такой?"
          }
        ],
        "total_duration": 45.72,
        "score": 0.85
      }
    ]
  }
}
```

## Запуск из командной строки

Помимо API, вы можете запустить сопоставление эпизода с помощью командного скрипта:

```bash
python match_episode.py 927ad83c-dbb5-4240-937b-81932d904740
```

Скрипт выполнит ту же функциональность, что и API эндпоинт, и сохранит результаты в директории `/app/shared-data/results/episode-matches/`.

## Формат результата

Результат сопоставления сохраняется в JSON-файл и содержит:

1. Информацию об эпизоде (ID, название)
2. Дату выполнения сопоставления
3. Список сюжетных линий с подобранными сценами для каждой:
   - Название и описание сюжета
   - Список задействованных персонажей
   - Ключевые слова сюжета
   - Список подобранных сцен с оценками совпадения
   - Общую длительность всех сцен
   - Общую оценку совпадения сюжета со сценами

## Нарезка видео на сюжеты

### GET /api/video-cutter/cut-by-storylines/{episode_id}

Нарезает видео на отдельные файлы для каждого сюжета на основе ранее созданного результата сопоставления.

#### Параметры URL
- `episode_id` (string, обязательный): Идентификатор эпизода

#### Параметры запроса
- `filename` (string, обязательный): Имя файла видео, которое нужно нарезать (должно находиться в директории sample-videos)

#### Пример запроса
```bash
curl -X GET "http://localhost:8000/api/video-cutter/cut-by-storylines/927ad83c-dbb5-4240-937b-81932d904740?filename=360.mp4"
```

#### Ответ
```json
{
  "status": "success",
  "message": "Видео успешно нарезано на 3 сюжетов",
  "result": {
    "episode_id": "927ad83c-dbb5-4240-937b-81932d904740",
    "video_filename": "360.mp4",
    "storylines_processed": 3,
    "results": [
      {
        "storyline_title": "Ошибки и нелепости интернов при первых пациентах",
        "output_path": "/app/shared-data/results/storyline-videos/927ad83c-dbb5-4240-937b-81932d904740/Ошибки_и_нелепости_интернов_при_первых_пациентах.mp4",
        "scenes_count": 298,
        "total_duration": 1156.34
      },
      {
        "storyline_title": "Прибытие интернов и первое знакомство с Быковым",
        "output_path": "/app/shared-data/results/storyline-videos/927ad83c-dbb5-4240-937b-81932d904740/Прибытие_интернов_и_первое_знакомство_с_Быковым.mp4",
        "scenes_count": 261,
        "total_duration": 1089.75
      },
      {
        "storyline_title": "Наказание и первое дежурство",
        "output_path": "/app/shared-data/results/storyline-videos/927ad83c-dbb5-4240-937b-81932d904740/Наказание_и_первое_дежурство.mp4",
        "scenes_count": 309,
        "total_duration": 1238.52
      }
    ]
  }
}
```

В результате создаются отдельные видеофайлы для каждого сюжета в директории `/app/shared-data/results/storyline-videos/{episode_id}/`.

## Важные примечания

1. Видеофайлы должны быть предварительно загружены в директорию `/app/shared-data/sample-videos/`.
2. Для нарезки видео необходимо сначала выполнить сопоставление эпизода с помощью `/api/episode-matcher/match-episode/{episode_id}`.
3. Результаты сопоставления и нарезки сохраняются на сервере и могут быть использованы повторно. 